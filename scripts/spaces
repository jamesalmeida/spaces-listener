#!/usr/bin/env bash
set -euo pipefail

# spaces-listener: Record and transcribe X/Twitter Spaces
# Usage: spaces listen <url> [options]

VERSION="1.2.0"
OUTPUT_DIR="$HOME/Desktop"
WHISPER_MODEL="base"
TRANSCRIBE=true
PID_FILE="$HOME/.spaces-listener.pid"
LOG_FILE=""

show_help() {
    cat << EOF
spaces-listener v${VERSION}
Record and transcribe X/Twitter Spaces

USAGE:
    spaces listen <url> [options]    Start recording a Space
    spaces status                    Check recording status
    spaces stop                      Stop current recording
    spaces transcribe <file>         Transcribe an audio file
    spaces help

OPTIONS:
    --output, -o DIR    Output directory (default: ~/Desktop)
    --model MODEL       Whisper model: tiny|base|small|medium|large (default: base)
    --no-transcribe     Skip auto-transcription when recording ends
    --help, -h          Show this help

EXAMPLES:
    spaces listen "https://x.com/i/spaces/1ABC..."
    spaces listen "https://x.com/i/spaces/1ABC..." --model medium
    spaces status
    spaces stop

REQUIREMENTS:
    brew install yt-dlp ffmpeg openai-whisper

VIDEO RECORDING:
    For video, use QuickTime Player with BlackHole for audio capture.
    See: https://github.com/jamesalmeida/spaces-listener#video-recording
EOF
}

check_deps() {
    local missing=()
    command -v yt-dlp >/dev/null || missing+=("yt-dlp")
    command -v ffmpeg >/dev/null || missing+=("ffmpeg")
    
    if [[ "$TRANSCRIBE" == true ]]; then
        command -v whisper >/dev/null || missing+=("openai-whisper")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "‚ùå Missing dependencies: ${missing[*]}"
        echo "   Install: brew install ${missing[*]}"
        exit 1
    fi
}

extract_username() {
    local url="$1"
    local info
    info=$(yt-dlp --dump-json "$url" 2>/dev/null | head -1) || true
    
    if [[ -n "$info" ]]; then
        local uploader
        uploader=$(echo "$info" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('uploader','unknown'))" 2>/dev/null) || uploader="unknown"
        uploader=$(echo "$uploader" | tr -cd '[:alnum:]_-' | head -c 30)
        echo "$uploader"
    else
        echo "space"
    fi
}

check_status() {
    if [[ -f "$PID_FILE" ]]; then
        local pid
        pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            local log_file
            log_file=$(cat "$HOME/.spaces-listener.log" 2>/dev/null || echo "")
            echo "üéß Recording in progress (PID: $pid)"
            if [[ -n "$log_file" && -f "$log_file" ]]; then
                echo ""
                echo "Recent progress:"
                tail -3 "$log_file" 2>/dev/null | grep -o "time=[0-9:.]* " | tail -1 || echo "   (starting...)"
            fi
            return 0
        else
            rm -f "$PID_FILE" "$HOME/.spaces-listener.log"
            echo "No active recording (stale PID file cleaned up)"
            return 1
        fi
    else
        echo "No active recording"
        return 1
    fi
}

stop_recording() {
    if [[ -f "$PID_FILE" ]]; then
        local pid
        pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            echo "üõë Stopping recording (PID: $pid)..."
            kill "$pid" 2>/dev/null || true
            sleep 2
            
            # Force kill if still running
            if ps -p "$pid" > /dev/null 2>&1; then
                kill -9 "$pid" 2>/dev/null || true
            fi
            
            rm -f "$PID_FILE"
            
            # Rename .part file if it exists
            local log_file
            log_file=$(cat "$HOME/.spaces-listener.log" 2>/dev/null || echo "")
            if [[ -n "$log_file" ]]; then
                local base_file="${log_file%.log}.m4a"
                if [[ -f "${base_file}.part" ]]; then
                    mv "${base_file}.part" "$base_file"
                    echo "‚úÖ Saved: $base_file"
                fi
            fi
            
            rm -f "$HOME/.spaces-listener.log"
            echo "Recording stopped."
        else
            rm -f "$PID_FILE" "$HOME/.spaces-listener.log"
            echo "No active recording (cleaned up stale files)"
        fi
    else
        echo "No active recording to stop"
    fi
}

transcribe_file() {
    local audio_file="$1"
    
    if [[ ! -f "$audio_file" ]]; then
        echo "‚ùå File not found: $audio_file"
        exit 1
    fi
    
    echo "üìù Transcribing: $audio_file"
    echo "   Model: $WHISPER_MODEL"
    echo ""
    
    local output_dir
    output_dir=$(dirname "$audio_file")
    
    whisper "$audio_file" \
        --model "$WHISPER_MODEL" \
        --output_format txt \
        --output_dir "$output_dir" 2>&1 | grep -v "^$" | tail -10
    
    local base_name
    base_name=$(basename "$audio_file" .m4a)
    local transcript="${output_dir}/${base_name}.txt"
    
    if [[ -f "$transcript" ]]; then
        echo ""
        echo "‚úÖ Transcript saved: $transcript"
        local words
        words=$(wc -w < "$transcript" | tr -d ' ')
        echo "   Words: $words"
    fi
}

listen() {
    local url="$1"
    local username="$2"
    
    # Check if already recording
    if [[ -f "$PID_FILE" ]]; then
        local pid
        pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            echo "‚ùå Already recording (PID: $pid)"
            echo "   Use 'spaces stop' to stop the current recording first."
            exit 1
        else
            rm -f "$PID_FILE"
        fi
    fi
    
    local date_str
    date_str=$(date +%Y-%m-%d_%H%M)
    local base_name="space_${username}_${date_str}"
    local audio_file="${OUTPUT_DIR}/${base_name}.m4a"
    LOG_FILE="${OUTPUT_DIR}/${base_name}.log"
    
    echo "üéß Starting Space recording..."
    echo "   URL: $url"
    echo "   Host: @${username}"
    echo "   Output: $audio_file"
    echo "   Log: $LOG_FILE"
    echo ""
    
    # Start recording in background with nohup
    nohup yt-dlp -f "bestaudio[ext=m4a]/bestaudio" \
        --no-warnings \
        -o "$audio_file" \
        "$url" > "$LOG_FILE" 2>&1 &
    
    local pid=$!
    echo "$pid" > "$PID_FILE"
    echo "$LOG_FILE" > "$HOME/.spaces-listener.log"
    
    # Wait a moment and verify it started
    sleep 3
    
    if ps -p "$pid" > /dev/null 2>&1; then
        echo "‚úÖ Recording started in background (PID: $pid)"
        echo ""
        echo "   The recording will continue until the Space ends."
        echo "   You can close this terminal ‚Äî recording persists."
        echo ""
        echo "   Commands:"
        echo "   ‚Ä¢ spaces status     ‚Äî check progress"
        echo "   ‚Ä¢ spaces stop       ‚Äî stop recording"
        echo ""
        
        # Show initial progress
        sleep 2
        if [[ -f "$LOG_FILE" ]]; then
            local progress
            progress=$(grep -o "time=[0-9:.]* " "$LOG_FILE" 2>/dev/null | tail -1 || echo "")
            if [[ -n "$progress" ]]; then
                echo "   Current: $progress"
            fi
        fi
    else
        echo "‚ùå Recording failed to start"
        echo "   Check log: $LOG_FILE"
        rm -f "$PID_FILE"
        exit 1
    fi
}

# Parse arguments
COMMAND=""
URL=""
AUDIO_FILE=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        listen)
            COMMAND="listen"
            shift
            ;;
        status)
            COMMAND="status"
            shift
            ;;
        stop)
            COMMAND="stop"
            shift
            ;;
        transcribe)
            COMMAND="transcribe"
            shift
            if [[ $# -gt 0 && ! "$1" =~ ^- ]]; then
                AUDIO_FILE="$1"
                shift
            fi
            ;;
        help|--help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            echo "spaces-listener v${VERSION}"
            exit 0
            ;;
        --output|-o)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        --model)
            WHISPER_MODEL="$2"
            shift 2
            ;;
        --no-transcribe)
            TRANSCRIBE=false
            shift
            ;;
        http*|https*)
            URL="$1"
            shift
            ;;
        *)
            if [[ -z "$URL" && "$1" =~ ^[0-9a-zA-Z] ]]; then
                URL="$1"
            fi
            shift
            ;;
    esac
done

# Handle commands
case "$COMMAND" in
    status)
        check_status
        exit $?
        ;;
    stop)
        stop_recording
        exit 0
        ;;
    transcribe)
        if [[ -z "$AUDIO_FILE" ]]; then
            echo "‚ùå Usage: spaces transcribe <audio_file>"
            exit 1
        fi
        check_deps
        transcribe_file "$AUDIO_FILE"
        exit 0
        ;;
    listen|"")
        if [[ -z "$URL" ]]; then
            show_help
            exit 1
        fi
        COMMAND="listen"
        ;;
esac

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

# Check dependencies
check_deps

# Extract username
echo "üîç Fetching Space info..."
USERNAME=$(extract_username "$URL")

# Start recording
listen "$URL" "$USERNAME"
