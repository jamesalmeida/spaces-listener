#!/usr/bin/env bash
set -euo pipefail

# spaces-listener: Record and transcribe X/Twitter Spaces
# Usage: spaces listen <url> [options]

VERSION="1.1.0"
OUTPUT_DIR="$HOME/Desktop"
WHISPER_MODEL="base"
TRANSCRIBE=true

show_help() {
    cat << EOF
spaces-listener v${VERSION}
Record and transcribe X/Twitter Spaces

USAGE:
    spaces listen <url> [options]
    spaces help

OPTIONS:
    --output, -o DIR    Output directory (default: ~/Desktop)
    --model MODEL       Whisper model: tiny|base|small|medium|large (default: base)
    --no-transcribe     Skip transcription
    --help, -h          Show this help

EXAMPLES:
    spaces listen "https://x.com/i/spaces/1ABC..."
    spaces listen "https://x.com/i/spaces/1ABC..." --model medium
    spaces listen "https://x.com/i/spaces/1ABC..." -o ~/Spaces

REQUIREMENTS:
    brew install yt-dlp ffmpeg openai-whisper

VIDEO RECORDING:
    For video, use QuickTime Player with BlackHole for audio capture.
    See: https://github.com/jamesalmeida/spaces-listener#video-recording
EOF
}

check_deps() {
    local missing=()
    command -v yt-dlp >/dev/null || missing+=("yt-dlp")
    command -v ffmpeg >/dev/null || missing+=("ffmpeg")
    
    if [[ "$TRANSCRIBE" == true ]]; then
        command -v whisper >/dev/null || missing+=("openai-whisper")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "âŒ Missing dependencies: ${missing[*]}"
        echo "   Install: brew install ${missing[*]}"
        exit 1
    fi
}

extract_username() {
    local url="$1"
    # Try to get username from Space metadata via yt-dlp
    local info
    info=$(yt-dlp --dump-json "$url" 2>/dev/null | head -1) || true
    
    if [[ -n "$info" ]]; then
        local uploader
        uploader=$(echo "$info" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('uploader','unknown'))" 2>/dev/null) || uploader="unknown"
        # Sanitize username for filename
        uploader=$(echo "$uploader" | tr -cd '[:alnum:]_-' | head -c 30)
        echo "$uploader"
    else
        echo "space"
    fi
}

listen() {
    local url="$1"
    local username="$2"
    local date_str
    date_str=$(date +%Y-%m-%d_%H%M)
    local base_name="space_${username}_${date_str}"
    local audio_file="${OUTPUT_DIR}/${base_name}.m4a"
    
    echo "ðŸŽ§ Recording Space..."
    echo "   URL: $url"
    echo "   Host: @${username}"
    echo "   Output: $audio_file"
    echo ""
    echo "   For live Spaces: recording continues until the Space ends."
    echo "   Press Ctrl+C to stop early."
    echo ""
    
    # Download audio
    yt-dlp -f "bestaudio[ext=m4a]/bestaudio" \
        --no-warnings \
        --no-progress \
        -o "$audio_file" \
        "$url" 2>&1 || {
            # If direct download fails, try with ffmpeg
            echo "âš ï¸  Direct download issue, trying alternate method..."
            local m3u8_url
            m3u8_url=$(yt-dlp -g "$url" 2>/dev/null | head -1)
            if [[ -n "$m3u8_url" ]]; then
                ffmpeg -i "$m3u8_url" -c copy "$audio_file" -y 2>/dev/null
            else
                echo "âŒ Could not download Space. It may be unavailable."
                exit 1
            fi
        }
    
    # Check if file was created
    if [[ ! -f "$audio_file" ]]; then
        echo "âŒ Audio file not created. The Space may be unavailable."
        exit 1
    fi
    
    echo ""
    echo "âœ… Audio saved: $audio_file"
    
    # Get file size
    local size
    size=$(ls -lh "$audio_file" | awk '{print $5}')
    echo "   Size: $size"
    
    # Transcribe
    if [[ "$TRANSCRIBE" == true ]]; then
        echo ""
        echo "ðŸ“ Transcribing with Whisper (model: $WHISPER_MODEL)..."
        echo "   This may take a moment..."
        
        whisper "$audio_file" \
            --model "$WHISPER_MODEL" \
            --output_format txt \
            --output_dir "$OUTPUT_DIR" 2>&1 | grep -v "^$" | tail -5
        
        local transcript="${OUTPUT_DIR}/${base_name}.txt"
        if [[ -f "$transcript" ]]; then
            echo ""
            echo "âœ… Transcript saved: $transcript"
            
            # Show word count
            local words
            words=$(wc -w < "$transcript" | tr -d ' ')
            echo "   Words: $words"
        fi
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ðŸŽ‰ Done!"
    echo ""
    echo "   Audio:      $audio_file"
    [[ "$TRANSCRIBE" == true ]] && echo "   Transcript: ${OUTPUT_DIR}/${base_name}.txt"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# Parse arguments
COMMAND=""
URL=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        listen)
            COMMAND="listen"
            shift
            ;;
        help|--help|-h)
            show_help
            exit 0
            ;;
        --version|-v)
            echo "spaces-listener v${VERSION}"
            exit 0
            ;;
        --output|-o)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        --model)
            WHISPER_MODEL="$2"
            shift 2
            ;;
        --no-transcribe)
            TRANSCRIBE=false
            shift
            ;;
        http*|https*)
            URL="$1"
            shift
            ;;
        *)
            if [[ -z "$URL" && "$1" =~ ^[0-9a-zA-Z] ]]; then
                URL="$1"
            fi
            shift
            ;;
    esac
done

# Validate
if [[ -z "$COMMAND" || "$COMMAND" != "listen" ]]; then
    if [[ -n "$URL" ]]; then
        COMMAND="listen"
    else
        show_help
        exit 1
    fi
fi

if [[ -z "$URL" ]]; then
    echo "âŒ Error: No Space URL provided"
    echo ""
    show_help
    exit 1
fi

# Ensure output directory exists
mkdir -p "$OUTPUT_DIR"

# Check dependencies
check_deps

# Extract username
echo "ðŸ” Fetching Space info..."
USERNAME=$(extract_username "$URL")

# Run
listen "$URL" "$USERNAME"
